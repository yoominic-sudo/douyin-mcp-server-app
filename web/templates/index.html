<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>抖音无水印下载</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body class="min-h-screen bg-slate-950 text-slate-100" x-data="downloaderApp()" x-init="init()">
  <div class="fixed inset-0 -z-10 bg-[radial-gradient(circle_at_20%_20%,rgba(244,63,94,0.25),transparent_35%),radial-gradient(circle_at_80%_0%,rgba(59,130,246,0.22),transparent_30%),linear-gradient(180deg,#020617_0%,#0f172a_100%)]"></div>

  <main class="mx-auto max-w-4xl px-4 py-6 sm:py-10">
    <header class="mb-5 sm:mb-8">
      <div class="inline-flex items-center gap-2 rounded-full border border-white/15 bg-white/10 px-3 py-1 text-xs text-pink-200 backdrop-blur">
        <span class="inline-block h-2 w-2 rounded-full bg-pink-400"></span>
        Douyin Toolkit
      </div>
      <h1 class="mt-3 text-2xl font-bold tracking-tight text-white sm:text-4xl">抖音无水印下载</h1>
      <p class="mt-2 max-w-2xl text-sm text-slate-300 sm:text-base">粘贴分享文案或链接，一键提取视频并直接下载。手机端优先，操作更快更直观。</p>
    </header>

    <section class="rounded-2xl border border-white/10 bg-white/10 p-4 shadow-2xl backdrop-blur-xl sm:p-6">
      <div class="rounded-xl border border-amber-300/30 bg-amber-100/10 px-3 py-2 text-xs leading-5 text-amber-100">
        免责声明：本工具仅供学习研究与个人备份使用，请确保你对下载内容拥有合法使用权，不得用于侵权传播或商业盗用。请遵守抖音平台规则及相关法律法规，因违规使用产生的责任由使用者自行承担。
      </div>

      <label class="mt-4 block text-sm font-medium text-slate-200">分享内容</label>
      <textarea
        x-model="url"
        rows="4"
        placeholder="粘贴抖音分享文案或链接，例如：https://v.douyin.com/xxxxx/"
        class="mt-2 w-full rounded-xl border border-white/15 bg-slate-900/70 p-3 text-sm text-slate-100 outline-none transition focus:border-pink-400 focus:ring-2 focus:ring-pink-400/20"
        :disabled="loading"
      ></textarea>

      <label class="mt-3 flex items-start gap-2 rounded-lg border border-white/10 bg-slate-900/50 px-3 py-2 text-xs text-slate-300">
        <input type="checkbox" x-model="agreed" class="mt-0.5 rounded border-slate-400 bg-slate-900 text-pink-500">
        <span>我已阅读并同意：仅用于学习研究与个人备份，不用于侵权传播或商业盗用。</span>
      </label>

      <div class="mt-4 flex flex-col gap-3 sm:flex-row sm:flex-wrap">
        <button
          @click="readClipboard"
          :disabled="loading"
          class="h-11 rounded-xl border border-white/20 bg-white/5 px-4 text-sm font-semibold text-slate-100 transition hover:bg-white/15 disabled:cursor-not-allowed disabled:opacity-50"
        >读取剪贴板</button>

        <button
          @click="extractVideo"
          :disabled="!url || loading || !agreed"
          class="h-11 rounded-xl bg-gradient-to-r from-pink-500 to-rose-500 px-5 text-sm font-semibold text-white transition hover:brightness-110 disabled:cursor-not-allowed disabled:from-slate-500 disabled:to-slate-500"
        >
          <span x-show="!loading">提取视频</span>
          <span x-show="loading">提取中...</span>
        </button>

        <button
          @click="reset"
          :disabled="loading"
          class="h-11 rounded-xl border border-white/20 bg-white/5 px-4 text-sm font-semibold text-slate-100 transition hover:bg-white/15 disabled:cursor-not-allowed disabled:opacity-50"
        >清空</button>
      </div>

      <label class="mt-3 inline-flex items-center gap-2 text-xs text-slate-300">
        <input type="checkbox" x-model="autoReadClipboard" class="rounded border-slate-400 bg-slate-900 text-pink-500">
        自动尝试读取剪贴板（页面重新聚焦时）
      </label>

      <p x-show="error" class="mt-3 rounded-xl border border-red-300/30 bg-red-500/15 px-3 py-2 text-sm text-red-100" x-text="error"></p>
    </section>

    <section x-show="videoInfo" x-transition class="mt-5 rounded-2xl border border-white/10 bg-white/10 p-4 shadow-2xl backdrop-blur-xl sm:p-6">
      <div class="flex items-start justify-between gap-3">
        <div>
          <h2 class="text-base font-semibold text-white sm:text-lg" x-text="videoInfo?.title"></h2>
          <p class="mt-1 text-xs text-slate-300">视频ID：<span class="font-mono" x-text="videoInfo?.video_id"></span></p>
        </div>
      </div>

      <div class="mt-4 overflow-hidden rounded-xl border border-white/15 bg-black">
        <video
          x-show="videoProxyUrl"
          :src="videoProxyUrl"
          controls
          playsinline
          class="aspect-[9/16] w-full bg-black sm:aspect-video"
        ></video>
      </div>

      <a
        x-show="videoProxyUrl"
        :href="videoProxyUrl"
        class="mt-4 inline-flex h-11 w-full items-center justify-center rounded-xl bg-gradient-to-r from-emerald-500 to-teal-500 px-4 text-sm font-semibold text-white transition hover:brightness-110 sm:w-auto"
      >下载无水印视频</a>
    </section>
  </main>

  <script>
    function downloaderApp() {
      const appBase = window.location.pathname.startsWith('/douyin') ? '/douyin' : '';
      return {
        appBase,
        url: '',
        loading: false,
        error: '',
        videoInfo: null,
        videoProxyUrl: '',
        autoReadClipboard: true,
        agreed: false,

        init() {
          window.addEventListener('focus', async () => {
            if (this.autoReadClipboard && !this.url) {
              await this.readClipboard(true);
            }
          });
          this.readClipboard(true);
        },

        async readClipboard(silent = false) {
          if (!navigator.clipboard || !navigator.clipboard.readText) {
            if (!silent) this.error = '当前浏览器不支持读取剪贴板';
            return;
          }
          try {
            const text = await navigator.clipboard.readText();
            if (text && text.trim()) this.url = text.trim();
            if (!silent && !text.trim()) this.error = '剪贴板为空';
          } catch (e) {
            if (!silent) this.error = '读取剪贴板失败，请检查浏览器权限';
          }
        },

        reset() {
          this.url = '';
          this.error = '';
          this.videoInfo = null;
          this.videoProxyUrl = '';
        },

        async extractVideo() {
          if (!this.url || this.loading || !this.agreed) return;
          this.loading = true;
          this.error = '';
          this.videoInfo = null;
          this.videoProxyUrl = '';

          try {
            const res = await fetch(`${this.appBase}/api/video/info`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ url: this.url })
            });
            const data = await res.json();

            if (!data.success) {
              this.error = data.error || '提取失败，请检查链接后重试';
              return;
            }

            this.videoInfo = data;
            this.videoProxyUrl = `${this.appBase}/api/video/download?url=${encodeURIComponent(data.download_url)}&filename=${encodeURIComponent((data.video_id || 'video') + '.mp4')}`;
          } catch (e) {
            this.error = '网络错误，请稍后再试';
          } finally {
            this.loading = false;
          }
        }
      };
    }
  </script>
</body>
</html>
