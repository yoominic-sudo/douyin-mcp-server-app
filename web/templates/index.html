<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æŠ–éŸ³æ— æ°´å°ä¸‹è½½</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body class="min-h-screen bg-slate-950 text-slate-100" x-data="downloaderApp({{ page_views | default(0) }})" x-init="init()">
  <div class="fixed inset-0 -z-10 bg-[radial-gradient(circle_at_20%_20%,rgba(244,63,94,0.25),transparent_35%),radial-gradient(circle_at_80%_0%,rgba(59,130,246,0.22),transparent_30%),linear-gradient(180deg,#020617_0%,#0f172a_100%)]"></div>

  <main class="mx-auto max-w-4xl px-4 py-6 sm:py-10">
    <header class="mb-5 sm:mb-8">
      <div class="inline-flex items-center gap-2 rounded-full border border-white/15 bg-white/10 px-3 py-1 text-xs text-pink-200 backdrop-blur">
        <span class="inline-block h-2 w-2 rounded-full bg-pink-400"></span>
        Douyin Toolkit
      </div>
      <h1 class="mt-3 text-2xl font-bold tracking-tight text-white sm:text-4xl">æŠ–éŸ³æ— æ°´å°ä¸‹è½½</h1>
      <p class="mt-2 max-w-2xl text-sm text-slate-300 sm:text-base">ç²˜è´´åˆ†äº«æ–‡æ¡ˆæˆ–é“¾æ¥ï¼Œä¸€é”®æå–è§†é¢‘å¹¶ç›´æ¥ä¸‹è½½ã€‚æ‰‹æœºç«¯ä¼˜å…ˆï¼Œæ“ä½œæ›´å¿«æ›´ç›´è§‚ã€‚</p>
      <div class="mt-3 inline-flex items-center gap-2 rounded-full border border-cyan-300/40 bg-cyan-400/10 px-3 py-1 text-xs text-cyan-100">
        <span>ğŸ‘€ æµè§ˆé‡</span>
        <span class="font-semibold" x-text="formatViews(pageViews)"></span>
      </div>
    </header>

    <section class="rounded-2xl border border-white/10 bg-white/10 p-4 shadow-2xl backdrop-blur-xl sm:p-6">
      <div class="rounded-xl border border-amber-300/30 bg-amber-100/10 px-3 py-2 text-xs leading-5 text-amber-100">
        å…è´£å£°æ˜ï¼šæœ¬å·¥å…·ä»…ä¾›å­¦ä¹ ç ”ç©¶ä¸ä¸ªäººå¤‡ä»½ä½¿ç”¨ï¼Œè¯·ç¡®ä¿ä½ å¯¹ä¸‹è½½å†…å®¹æ‹¥æœ‰åˆæ³•ä½¿ç”¨æƒï¼Œä¸å¾—ç”¨äºä¾µæƒä¼ æ’­æˆ–å•†ä¸šç›—ç”¨ã€‚è¯·éµå®ˆæŠ–éŸ³å¹³å°è§„åˆ™åŠç›¸å…³æ³•å¾‹æ³•è§„ï¼Œå› è¿è§„ä½¿ç”¨äº§ç”Ÿçš„è´£ä»»ç”±ä½¿ç”¨è€…è‡ªè¡Œæ‰¿æ‹…ã€‚
      </div>

      <label class="mt-4 block text-sm font-medium text-slate-200">åˆ†äº«å†…å®¹</label>
      <textarea
        x-model="url"
        rows="4"
        placeholder="ç²˜è´´æŠ–éŸ³åˆ†äº«æ–‡æ¡ˆæˆ–é“¾æ¥ï¼Œä¾‹å¦‚ï¼šhttps://v.douyin.com/xxxxx/"
        class="mt-2 w-full rounded-xl border border-white/15 bg-slate-900/70 p-3 text-sm text-slate-100 outline-none transition focus:border-pink-400 focus:ring-2 focus:ring-pink-400/20"
        :disabled="loading"
      ></textarea>

      <label class="mt-3 flex items-start gap-2 rounded-lg border border-white/10 bg-slate-900/50 px-3 py-2 text-xs text-slate-300">
        <input type="checkbox" x-model="agreed" class="mt-0.5 rounded border-slate-400 bg-slate-900 text-pink-500">
        <span>æˆ‘å·²é˜…è¯»å¹¶åŒæ„ï¼šä»…ç”¨äºå­¦ä¹ ç ”ç©¶ä¸ä¸ªäººå¤‡ä»½ï¼Œä¸ç”¨äºä¾µæƒä¼ æ’­æˆ–å•†ä¸šç›—ç”¨ã€‚</span>
      </label>

      <div class="mt-4 flex flex-col gap-3 sm:flex-row sm:flex-wrap">
        <button
          @click="readClipboard"
          :disabled="loading"
          class="h-11 rounded-xl border border-white/20 bg-white/5 px-4 text-sm font-semibold text-slate-100 transition hover:bg-white/15 disabled:cursor-not-allowed disabled:opacity-50"
        >è¯»å–å‰ªè´´æ¿</button>

        <button
          @click="extractVideo"
          :disabled="!url || loading || !agreed"
          class="h-11 rounded-xl bg-gradient-to-r from-pink-500 to-rose-500 px-5 text-sm font-semibold text-white transition hover:brightness-110 disabled:cursor-not-allowed disabled:from-slate-500 disabled:to-slate-500"
        >
          <span x-show="!loading">æå–è§†é¢‘</span>
          <span x-show="loading">æå–ä¸­...</span>
        </button>

        <button
          @click="reset"
          :disabled="loading"
          class="h-11 rounded-xl border border-white/20 bg-white/5 px-4 text-sm font-semibold text-slate-100 transition hover:bg-white/15 disabled:cursor-not-allowed disabled:opacity-50"
        >æ¸…ç©º</button>
      </div>

      <label class="mt-3 inline-flex items-center gap-2 text-xs text-slate-300">
        <input type="checkbox" x-model="autoReadClipboard" class="rounded border-slate-400 bg-slate-900 text-pink-500">
        è‡ªåŠ¨å°è¯•è¯»å–å‰ªè´´æ¿ï¼ˆé¡µé¢é‡æ–°èšç„¦æ—¶ï¼‰
      </label>

      <p x-show="error" class="mt-3 rounded-xl border border-red-300/30 bg-red-500/15 px-3 py-2 text-sm text-red-100" x-text="error"></p>
    </section>

    <section x-show="videoInfo" x-transition class="mt-5 rounded-2xl border border-white/10 bg-white/10 p-4 shadow-2xl backdrop-blur-xl sm:p-6">
      <div class="flex items-start justify-between gap-3">
        <div>
          <h2 class="text-base font-semibold text-white sm:text-lg" x-text="videoInfo?.title"></h2>
          <p class="mt-1 text-xs text-slate-300">è§†é¢‘IDï¼š<span class="font-mono" x-text="videoInfo?.video_id"></span></p>
        </div>
      </div>

      <div class="mt-4 overflow-hidden rounded-xl border border-white/15 bg-black">
        <video
          x-show="videoProxyUrl"
          :src="videoProxyUrl"
          controls
          playsinline
          class="aspect-[9/16] w-full bg-black sm:aspect-video"
        ></video>
      </div>

      <a
        x-show="videoProxyUrl"
        :href="videoProxyUrl"
        class="mt-4 inline-flex h-11 w-full items-center justify-center rounded-xl bg-gradient-to-r from-emerald-500 to-teal-500 px-4 text-sm font-semibold text-white transition hover:brightness-110 sm:w-auto"
      >ä¸‹è½½æ— æ°´å°è§†é¢‘</a>
    </section>
  </main>

  <script>
    function downloaderApp(initialPageViews = 0) {
      const appBase = window.location.pathname.startsWith('/douyin') ? '/douyin' : '';
      return {
        appBase,
        url: '',
        loading: false,
        error: '',
        videoInfo: null,
        videoProxyUrl: '',
        autoReadClipboard: true,
        agreed: false,
        pageViews: Number(initialPageViews) || 0,

        async init() {
          window.addEventListener('focus', async () => {
            if (this.autoReadClipboard && !this.url) {
              await this.readClipboard(true);
            }
          });
          this.readClipboard(true);
          await this.fetchStats();
        },

        async readClipboard(silent = false) {
          if (!navigator.clipboard || !navigator.clipboard.readText) {
            if (!silent) this.error = 'å½“å‰æµè§ˆå™¨ä¸æ”¯æŒè¯»å–å‰ªè´´æ¿';
            return;
          }
          try {
            const text = await navigator.clipboard.readText();
            if (text && text.trim()) this.url = text.trim();
            if (!silent && !text.trim()) this.error = 'å‰ªè´´æ¿ä¸ºç©º';
          } catch (e) {
            if (!silent) this.error = 'è¯»å–å‰ªè´´æ¿å¤±è´¥ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æƒé™';
          }
        },

        async fetchStats() {
          try {
            const res = await fetch(`${this.appBase}/api/stats`);
            if (!res.ok) return;
            const data = await res.json();
            if (typeof data.page_views === 'number') {
              this.pageViews = data.page_views;
            }
          } catch (e) {
          }
        },

        formatViews(value) {
          const num = Number(value) || 0;
          return num.toLocaleString('zh-CN');
        },

        reset() {
          this.url = '';
          this.error = '';
          this.videoInfo = null;
          this.videoProxyUrl = '';
        },

        async extractVideo() {
          if (!this.url || this.loading || !this.agreed) return;
          this.loading = true;
          this.error = '';
          this.videoInfo = null;
          this.videoProxyUrl = '';

          try {
            const res = await fetch(`${this.appBase}/api/video/info`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ url: this.url })
            });
            const data = await res.json();

            if (!data.success) {
              this.error = data.error || 'æå–å¤±è´¥ï¼Œè¯·æ£€æŸ¥é“¾æ¥åé‡è¯•';
              return;
            }

            this.videoInfo = data;
            this.videoProxyUrl = `${this.appBase}/api/video/download?url=${encodeURIComponent(data.download_url)}&filename=${encodeURIComponent((data.video_id || 'video') + '.mp4')}`;
          } catch (e) {
            this.error = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åå†è¯•';
          } finally {
            this.loading = false;
          }
        }
      };
    }
  </script>
</body>
</html>
