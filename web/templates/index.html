<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>抖音无水印下载</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body class="min-h-screen bg-slate-50" x-data="downloaderApp()" x-init="init()">
  <main class="mx-auto max-w-3xl px-4 py-6 sm:py-10">
    <section class="rounded-2xl bg-white p-4 shadow-sm sm:p-6">
      <h1 class="text-xl font-bold text-slate-900 sm:text-2xl">抖音无水印下载</h1>
      <p class="mt-1 text-sm text-slate-500">粘贴分享文案或链接，提取视频后可直接播放和下载。</p>
      <p class="mt-2 rounded-lg bg-amber-50 px-3 py-2 text-xs leading-5 text-amber-700">
        免责声明：本工具仅供学习研究与个人备份使用，请确保你对下载内容拥有合法使用权，不得用于侵权传播或商业盗用。请遵守抖音平台规则及相关法律法规，因违规使用产生的责任由使用者自行承担。
      </p>

      <label class="mt-4 block text-sm font-medium text-slate-700">分享内容</label>
      <textarea
        x-model="url"
        rows="4"
        placeholder="粘贴抖音分享文案或链接，例如：https://v.douyin.com/xxxxx/"
        class="mt-2 w-full rounded-xl border border-slate-200 p-3 text-sm outline-none transition focus:border-pink-500 focus:ring-2 focus:ring-pink-100"
        :disabled="loading"
      ></textarea>

      <label class="mt-3 flex items-start gap-2 rounded-lg bg-slate-100 px-3 py-2 text-xs text-slate-600">
        <input type="checkbox" x-model="agreed" class="mt-0.5 rounded border-slate-300">
        <span>我已阅读并同意：仅用于学习研究与个人备份，不用于侵权传播或商业盗用。</span>
      </label>

      <div class="mt-4 flex flex-col gap-3 sm:flex-row sm:flex-wrap">
        <button
          @click="readClipboard"
          :disabled="loading"
          class="h-11 rounded-xl border border-slate-200 px-4 text-sm font-semibold text-slate-700 transition hover:bg-slate-100 disabled:cursor-not-allowed"
        >读取剪贴板</button>
        <button
          @click="extractVideo"
          :disabled="!url || loading || !agreed"
          class="h-11 rounded-xl bg-pink-600 px-4 text-sm font-semibold text-white transition hover:bg-pink-500 disabled:cursor-not-allowed disabled:bg-slate-300"
        >
          <span x-show="!loading">提取视频</span>
          <span x-show="loading">提取中...</span>
        </button>
        <button
          @click="reset"
          :disabled="loading"
          class="h-11 rounded-xl border border-slate-200 px-4 text-sm font-semibold text-slate-700 transition hover:bg-slate-100 disabled:cursor-not-allowed"
        >清空</button>
      </div>
      <label class="mt-3 inline-flex items-center gap-2 text-xs text-slate-500">
        <input type="checkbox" x-model="autoReadClipboard" class="rounded border-slate-300">
        自动尝试读取剪贴板（页面重新聚焦时）
      </label>

      <p x-show="error" class="mt-3 rounded-xl bg-red-50 px-3 py-2 text-sm text-red-600" x-text="error"></p>
    </section>

    <section x-show="videoInfo" x-transition class="mt-5 rounded-2xl bg-white p-4 shadow-sm sm:p-6">
      <div class="flex items-start justify-between gap-3">
        <div>
          <h2 class="text-base font-semibold text-slate-900 sm:text-lg" x-text="videoInfo?.title"></h2>
          <p class="mt-1 text-xs text-slate-500">视频ID：<span x-text="videoInfo?.video_id"></span></p>
        </div>
      </div>

      <div class="mt-4 overflow-hidden rounded-xl bg-black">
        <video
          x-show="videoProxyUrl"
          :src="videoProxyUrl"
          controls
          playsinline
          class="aspect-[9/16] w-full bg-black sm:aspect-video"
        ></video>
      </div>

      <a
        x-show="videoProxyUrl"
        :href="videoProxyUrl"
        class="mt-4 inline-flex h-11 w-full items-center justify-center rounded-xl bg-emerald-600 px-4 text-sm font-semibold text-white transition hover:bg-emerald-500 sm:w-auto"
      >下载无水印视频</a>
    </section>
  </main>

  <script>
    function downloaderApp() {
      const appBase = window.location.pathname.startsWith('/douyin') ? '/douyin' : '';
      return {
        appBase,
        url: '',
        loading: false,
        error: '',
        videoInfo: null,
        videoProxyUrl: '',
        autoReadClipboard: true,
        agreed: false,

        init() {
          window.addEventListener('focus', async () => {
            if (this.autoReadClipboard && !this.url) {
              await this.readClipboard(true);
            }
          });
          this.readClipboard(true);
        },

        async readClipboard(silent = false) {
          if (!navigator.clipboard || !navigator.clipboard.readText) {
            if (!silent) this.error = '当前浏览器不支持读取剪贴板';
            return;
          }
          try {
            const text = await navigator.clipboard.readText();
            if (text && text.trim()) this.url = text.trim();
            if (!silent && !text.trim()) this.error = '剪贴板为空';
          } catch (e) {
            if (!silent) this.error = '读取剪贴板失败，请检查浏览器权限';
          }
        },

        reset() {
          this.url = '';
          this.error = '';
          this.videoInfo = null;
          this.videoProxyUrl = '';
        },

        async extractVideo() {
          if (!this.url || this.loading) return;
          this.loading = true;
          this.error = '';
          this.videoInfo = null;
          this.videoProxyUrl = '';

          try {
            const res = await fetch(`${this.appBase}/api/video/info`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ url: this.url })
            });
            const data = await res.json();

            if (!data.success) {
              this.error = data.error || '提取失败，请检查链接后重试';
              return;
            }

            this.videoInfo = data;
            this.videoProxyUrl = `${this.appBase}/api/video/download?url=${encodeURIComponent(data.download_url)}&filename=${encodeURIComponent((data.video_id || 'video') + '.mp4')}`;
          } catch (e) {
            this.error = '网络错误，请稍后再试';
          } finally {
            this.loading = false;
          }
        }
      };
    }
  </script>
</body>
</html>
